# HugWBC 轨迹采集系统总结

## 系统概述

本系统为HugWBC项目设计，用于采集H1人形机器人的运动轨迹数据。系统支持两种类型的轨迹采集：
1. **恒定命令轨迹**：整个轨迹期间环境命令保持不变
2. **变化命令轨迹**：前5秒使用一个命令，后5秒切换到另一个命令

## 核心功能

### 1. 轨迹采集 (`collect_trajectories.py`)

#### 主要特性
- **全局索引系统**：每条轨迹使用连续的整数索引（0, 1, 2, ...）作为唯一标识符
- **命令采样**：从训练配置中定义的可行域内均匀随机采样命令
- **物理约束**：应用物理合理性约束，确保命令组合的可行性
- **数据持久化**：轨迹数据保存为`.npz`格式，元数据保存为JSON格式

#### 轨迹标识符系统
- **文件命名**：使用6位数字格式（如`000000.npz`, `000001.npz`）
- **全局索引**：从0开始递增，确保唯一性和连续性
- **元数据键值**：使用索引作为JSON字典的键
- **持久化**：支持中断后继续，自动恢复全局索引计数器

#### 命令范围定义
```python
# 线性速度 (m/s)
lin_vel_x: [-1.0, 1.0]      # 前进/后退速度
lin_vel_y: [-0.5, 0.5]      # 左右移动速度
ang_vel_yaw: [-0.5, 0.5]    # 转向速度

# 步态参数
gait_frequency: [1.5, 3.5]   # 步态频率 (Hz)
gait_phase: [0.0, 1.0]      # 步态相位
foot_swing_height: [0.05, 0.25]  # 脚部摆动高度 (m)

# 身体姿态
body_height: [-0.3, 0.1]     # 身体高度偏移 (m)
body_pitch: [-0.3, 0.3]      # 身体俯仰角 (rad)
waist_roll: [-1.0, 1.0]      # 腰部侧倾角 (rad)
```

#### 物理约束应用
- **高速约束**：高速度时要求更高的步态频率
- **高度约束**：低身体高度时限制脚部摆动高度
- **稳定性约束**：确保命令组合不会导致机器人不稳定

### 2. 数据格式

#### 轨迹数据 (.npz)
- **obs**: 观察数据 (时间步, 环境数, 历史步数, 观察维度)
- **critic_obs**: 评论家观察数据 (时间步, 环境数, 观察维度)
- **actions**: 动作数据 (时间步, 环境数, 动作维度)
- **rewards**: 奖励数据 (时间步, 环境数)
- **dones**: 终止标志 (时间步, 环境数)
- **root_states**: 根状态 (时间步, 环境数, 状态维度)
- **commands**: 命令数据 (时间步, 命令维度)
- **dt**: 时间步长

#### 元数据 (JSON)
```json
{
  "0": {
    "trajectory_index": 0,
    "trajectory_id": "0",
    "trajectory_type": "constant",
    "commands": [[...]],
    "length_s": 10.0,
    "length_timesteps": 101,
    "collection_time": "2025-08-24T02:14:28.180306",
    "file_path": "collected_trajectories/000000.npz"
  }
}
```

### 3. 使用示例 (`example_usage.py`)

提供完整的轨迹数据加载和分析功能：
- 元数据加载和解析
- 轨迹数据加载和形状分析
- 命令信息提取和显示
- 统计信息计算
- 数据使用建议

## 技术实现

### 1. Isaac Gym集成
- 使用`gymutil.parse_arguments`进行参数解析
- 支持无头模式运行
- 自动环境配置和策略加载

### 2. 数据管理
- 实时元数据更新和持久化
- 支持中断后继续采集
- 全局索引计数器自动管理

### 3. 错误处理
- 优雅处理环境提前终止
- 元数据加载失败时的容错处理
- 命令约束违反时的自动调整

## 使用方法

### 1. 基本采集
```bash
# 采集恒定命令轨迹
python legged_gym/scripts/collect_trajectories.py \
    --task=h1int \
    --num_constant=10 \
    --num_changing=10 \
    --headless

# 使用训练好的策略
python legged_gym/scripts/collect_trajectories.py \
    --task=h1int \
    --num_constant=5 \
    --num_changing=5 \
    --load_checkpoint \
    --headless
```

### 2. 数据分析
```bash
# 分析采集的轨迹
python example_usage.py
```

### 3. 参数说明
- `--task`: 任务名称（默认：h1int）
- `--num_constant`: 恒定命令轨迹数量
- `--num_changing`: 变化命令轨迹数量
- `--load_checkpoint`: 是否加载训练好的策略
- `--headless`: 是否无头模式运行

## 系统优势

### 1. 数据质量
- 从训练配置中采样，确保命令的可行性
- 应用物理约束，保证数据的合理性
- 支持两种轨迹类型，增加数据多样性

### 2. 系统稳定性
- 全局索引系统，避免标识符冲突
- 支持中断后继续，提高采集效率
- 完善的错误处理和容错机制

### 3. 扩展性
- 模块化设计，易于添加新的轨迹类型
- 灵活的元数据结构，支持自定义字段
- 标准化的数据格式，便于后续处理

## 注意事项

### 1. 环境要求
- 需要激活包含Isaac Gym的conda环境
- 确保有足够的GPU内存运行仿真
- 建议在无头模式下进行大规模采集

### 2. 数据管理
- 定期备份元数据文件
- 注意磁盘空间，轨迹文件可能较大
- 建议按批次组织采集的数据

### 3. 性能优化
- 使用无头模式提高采集速度
- 适当调整环境数量平衡速度和稳定性
- 考虑使用SSD存储提高I/O性能

## 更新日志

### 2025-08-24
- **轨迹标识符系统重构**：从UUID改为全局整数索引
- **文件命名优化**：使用6位数字格式（000000.npz, 000001.npz, ...）
- **全局索引管理**：实现自动递增的索引计数器
- **元数据键值更新**：使用索引作为JSON字典的键
- **持久化支持**：支持中断后继续，自动恢复索引计数器
- **向后兼容性**：保持现有元数据结构的兼容性

### 主要改进
1. **标识符唯一性**：全局索引确保每条轨迹有唯一的连续标识符
2. **文件管理**：数字命名便于排序和批量处理
3. **系统稳定性**：支持中断恢复，避免索引冲突
4. **用户体验**：更直观的轨迹标识和文件组织

## 未来扩展

### 1. 功能增强
- 支持更多轨迹类型（如多段命令变化）
- 添加轨迹质量评估和筛选
- 实现自动化的数据清洗和预处理

### 2. 性能优化
- 并行轨迹采集
- 实时数据压缩和传输
- 分布式存储支持

### 3. 分析工具
- 轨迹可视化界面
- 统计分析报告
- 机器学习数据预处理工具

